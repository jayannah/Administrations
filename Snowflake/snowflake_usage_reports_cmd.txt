-- USER LOGIN HISTORY

SELECT USER_NAME,TO_DATE(EVENT_TIMESTAMP) AS LOGIN_DATE, COUNT(*) AS USR_CNT  FROM "SNOWFLAKE"."ACCOUNT_USAGE"."LOGIN_HISTORY"
WHERE IS_SUCCESS = 'YES'
AND TO_DATE(EVENT_TIMESTAMP) >= '2023-04-01'
GROUP BY USER_NAME,TO_DATE(EVENT_TIMESTAMP);

-- STORAGE HISTORY

SELECT * FROM "SNOWFLAKE"."ACCOUNT_USAGE"."DATABASE_STORAGE_USAGE_HISTORY" 
WHERE USAGE_DATE >= '2023-02-01'
AND SUBSTR(DATABASE_NAME,5) IN ('UWRATE','COC','SADL','EDM','EDM_V3')
AND SUBSTR(DATABASE_NAME,1,3) = 'P01'

-- USER CREDITS HISTORY

SELECT APPLICATION, USER_NAME, WAREHOUSE_SIZE, USAGE_DATE, 
CASE
WHEN WAREHOUSE_SIZE='XS' THEN TIME*1 
WHEN WAREHOUSE_SIZE='S' THEN TIME*2
WHEN WAREHOUSE_SIZE='M' THEN TIME*4
WHEN WAREHOUSE_SIZE='L' THEN TIME*8
WHEN WAREHOUSE_SIZE='XL' THEN TIME*16
WHEN WAREHOUSE_SIZE='2XL' THEN TIME*32
WHEN WAREHOUSE_SIZE='3XL' THEN TIME*64
WHEN WAREHOUSE_SIZE='4XL' THEN TIME*128
WHEN WAREHOUSE_SIZE='5XL' THEN TIME*256
END AS CREDITS FROM (
SELECT APPLICATION, USER_NAME, WAREHOUSE_SIZE, USAGE_DATE, SUM(EXEC_TIME_IN_HR) AS TIME FROM (
SELECT 
REPLACE(DATABASE_NAME,'P01_') AS APPLICATION,
WAREHOUSE_NAME,
CAST(SPLIT(WAREHOUSE_NAME,'_')[ARRAY_SIZE(SPLIT(WAREHOUSE_NAME,'_'))-1] AS STRING) AS WAREHOUSE_SIZE,
USER_NAME,
START_TIME :: DATE AS USAGE_DATE,
CASE WHEN ROUND(TOTAL_ELAPSED_TIME/1000,0) < 60 THEN 1/60 ELSE TOTAL_ELAPSED_TIME/1000/60/60 END AS EXEC_TIME_IN_HR
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE WAREHOUSE_NAME IS NOT NULL
AND SUBSTR(DATABASE_NAME,5)  IN ('UWRATE','COC','SADL','EDM','EDM_V3')
AND SUBSTR(DATABASE_NAME,1,3)='P01'
AND TOTAL_ELAPSED_TIME > 0
AND START_TIME >= '2023-04-01'
)A
  WHERE WAREHOUSE_SIZE <> 'WH'
GROUP BY 1,2,3,4
)B;

-- WAREHOUSE STATS BY QUERY HISTORY

SELECT
    QUERY_TYPE,
    EXECUTION_DATE,
    REPLACE(DATABASE_NAME,'P01_','') AS APPLICATION,
    WAREHOUSE_NAME,
    USER_NAME,
    WAREHOUSE_SIZE,
    COUNT(DISTINCT QUERY_ID) AS NUMJOBS,
    MEDIAN(TOTAL_ELAPSED_TIME)/1000 AS P50_TOTAL_DURATION,
    (PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY TOTAL_ELAPSED_TIME))/1000 AS P95_TOTAL_DURATION,
    SUM(TOTAL_ELAPSED_TIME)/1000 AS SUM_TOTAL_DURATION,
    SUM(COMPILATION_AND_SCHEDULING_TIME)/1000 AS SUM_COMPILATION_AND_SCHEDULING_TIME,
    SUM(QUEUED_TIME)/1000 AS SUM_QUEUED_TIME,
    SUM(TRANSACTION_BLOCKED_TIME)/1000 AS SUM_TRANSACTION_BLOCKED_TIME,
    SUM(EXECUTION_TIME)/1000 AS SUM_EXECUTION_TIME,
    ROUND(SUM_COMPILATION_AND_SCHEDULING_TIME/SUM_TOTAL_DURATION,2) AS COMPILATION_AND_SCHEDULING_RATIO,
    ROUND(SUM_QUEUED_TIME/SUM_TOTAL_DURATION,2) AS QUEUED_RATIO,
    ROUND(SUM_TRANSACTION_BLOCKED_TIME/SUM_TOTAL_DURATION,2) AS BLOCKED_RATIO,
    ROUND(SUM_EXECUTION_TIME/SUM_TOTAL_DURATION,2) AS EXECUTION_RATIO,
    ROUND(SUM_TOTAL_DURATION/NUMJOBS,2) AS TOTAL_DURATION_PERJOB,
    ROUND(SUM_COMPILATION_AND_SCHEDULING_TIME/NUMJOBS,2) AS COMPILATION_AND_SCHEDULING_PERJOB,
    ROUND(SUM_QUEUED_TIME/NUMJOBS,2) AS QUEUED_PERJOB,
    ROUND(SUM_TRANSACTION_BLOCKED_TIME/NUMJOBS,2) AS BLOCKED_PERJOB,
    ROUND(SUM_EXECUTION_TIME/NUMJOBS,2) AS EXECUTION_PERJOB,
    ROUND(SUM(CREDITS_USED_CLOUD_SERVICES),2) AS CREDITS_USED_CLOUD_SERVICES
FROM
(
SELECT
    QUERY_ID,
    START_TIME::DATE AS EXECUTION_DATE,
    WAREHOUSE_NAME,
    WAREHOUSE_SIZE,
    USER_NAME,
    DATABASE_NAME,
    QUERY_TYPE,
    TOTAL_ELAPSED_TIME,
    COMPILATION_TIME AS COMPILATION_AND_SCHEDULING_TIME,
    (QUEUED_PROVISIONING_TIME + QUEUED_REPAIR_TIME + QUEUED_OVERLOAD_TIME) AS QUEUED_TIME,
    TRANSACTION_BLOCKED_TIME,
    EXECUTION_TIME,
    CREDITS_USED_CLOUD_SERVICES
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE
START_TIME >= '2023-04-01'
AND EXECUTION_STATUS = 'SUCCESS'
AND QUERY_TYPE IN ('UPDATE','INSERT','MERGE','DELETE','SELECT')
AND SUBSTR(WAREHOUSE_NAME,1,3) = 'P01' 
AND SUBSTR(DATABASE_NAME,1,3) = 'P01'
AND SUBSTR(DATABASE_NAME,5) IN ('UWRATE','COC','SADL','EDM','EDM_V3')
)A
GROUP BY 1,2,3,4,5,6

-- WAREHOUSE HISTORY

SELECT A.WAREHOUSE_ID, A.WAREHOUSE_NAME, A.USAGE_DATE, A.AVG_RUNNING, A.AVG_QUEUED_LOAD, A.AVG_QUEUED_PROVISIONING,
A.AVG_BLOCKED, B.TOTAL_CREDITS_USED, B.TOTAL_COST
FROM (
SELECT 
START_TIME::DATE AS USAGE_DATE,
WAREHOUSE_ID,
WAREHOUSE_NAME,
ROUND(AVG(AVG_RUNNING),3) AS AVG_RUNNING,
ROUND(AVG(AVG_QUEUED_LOAD),3) AS AVG_QUEUED_LOAD,
ROUND(AVG(AVG_QUEUED_PROVISIONING),3) AS AVG_QUEUED_PROVISIONING,
ROUND(AVG(AVG_BLOCKED),3) AS AVG_BLOCKED
FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_LOAD_HISTORY
WHERE START_TIME >= '2023-04-01'
AND SUBSTR(WAREHOUSE_NAME,1,3) = 'P01' 
AND SPLIT(WAREHOUSE_NAME,'_')[1] IN ('UWRATE','COC','SADL','EDM','EDM_V3')
GROUP BY 1, 2, 3
)A
INNER JOIN (
SELECT 
START_TIME::DATE AS USAGE_DATE,
WAREHOUSE_ID,
WAREHOUSE_NAME,
ROUND(SUM(CREDITS_USED),3) AS TOTAL_CREDITS_USED,
TOTAL_CREDITS_USED * 2.4 AS TOTAL_COST
FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE START_TIME >= '2023-04-01'
AND SUBSTR(WAREHOUSE_NAME,1,3) = 'P01'
AND SPLIT(WAREHOUSE_NAME,'_')[1] IN ('UWRATE','COC','SADL','EDM','EDM_V3')
GROUP BY 1,2,3
)
B
ON  A.WAREHOUSE_ID = B.WAREHOUSE_ID
AND A.USAGE_DATE   = B.USAGE_DATE;

-- TABLE HISTORY

SELECT TABLE_ID, TABLE_NAME, TABLE_SCHEMA AS SCHEMA_NAME, TABLE_CATALOG AS DATABASE_NAME, ROW_COUNT, BYTES, CREATED, LAST_ALTERED
FROM SNOWFLAKE.ACCOUNT_USAGE.TABLES 
WHERE TABLE_TYPE='BASE TABLE'
AND SUBSTR(TABLE_CATALOG,5) IN ('UWRATE','COC','SADL','EDM','EDM_V3') 
AND SUBSTR(TABLE_CATALOG,1,3)='P01';

-- QUERY HISTORY

create or replace TEMPORARY table P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache
as
select  *
from table(get_query_operator_stats(last_query_id()))
limit 0;

create or replace TEMPORARY table P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache
(
  QUERY_ID STRING, 
  TRGT_TBL STRING,
  SRC_TBL  STRING
);

create or replace TEMPORARY table P01_UWRATE.UWRATE_STG_NOGBD.query_id
(
  QUERY_ID STRING
);

SELECT * FROM P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache;

EXECUTE IMMEDIATE $$
declare query_id string;
query string;
c1 cursor for
select query_id
from "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
WHERE WAREHOUSE_NAME LIKE 'P01%LOAD%' AND 
START_TIME >= '2023-07-11'  
AND QUERY_TYPE IN ('INSERT')
AND USER_NAME IN ('SRCUWRATEDP')
AND query_id not in (select query_id from P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache);
begin
  open c1;
  for record in c1 do
    query := record.query_id;
    insert into P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache
    SELECT 
    QUERY_ID,
    LISTAGG(CASE WHEN OPERATOR_TYPE='Insert' then OPERATOR_ATTRIBUTES['table_names'][0] else NULL end,' ,') as TRGT_TBL,
    LISTAGG(CASE WHEN OPERATOR_TYPE='TableScan' then OPERATOR_ATTRIBUTES['table_name'] else NULL end,' ,') as SRC_TBL
    from table(get_query_operator_stats(:query))
    where operator_type in ('Insert','TableScan') and query_id is not null
    GROUP BY QUERY_ID;
  end for;
end;
$$;

SELECT Q.QUERY_ID, DATABASE_NAME, SCHEMA_NAME, QUERY_TEXT AS TABLE_NAME_LINE, 
QUERY_TYPE, USER_NAME, ROLE_NAME,EXECUTION_STATUS,
WAREHOUSE_SIZE, WAREHOUSE_NAME, QUERY_TAG,START_TIME, END_TIME, TOTAL_ELAPSED_TIME,BYTES_SCANNED, PERCENTAGE_SCANNED_FROM_CACHE,
BYTES_WRITTEN, BYTES_WRITTEN_TO_RESULT,ROWS_PRODUCED, ROWS_INSERTED, ROWS_UPDATED,PARTITIONS_SCANNED, PARTITIONS_TOTAL,
BYTES_SPILLED_TO_LOCAL_STORAGE, BYTES_SPILLED_TO_REMOTE_STORAGE, BYTES_SENT_OVER_THE_NETWORK, COMPILATION_TIME, EXECUTION_TIME, QUEUED_OVERLOAD_TIME,
CREDITS_USED_CLOUD_SERVICES, QUERY_LOAD_PERCENT, TRGT_TBL, SRC_TBL
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY" Q
LEFT JOIN P01_UWRATE.UWRATE_STG_NOGBD.query_operator_stats_cache S
ON Q.QUERY_ID = S.QUERY_ID
WHERE 
WAREHOUSE_NAME LIKE 'P01%LOAD%' AND 
START_TIME >= '2023-07-11'  
AND QUERY_TYPE IN ('INSERT')
AND USER_NAME='SRCUWRATEDP'
ORDER BY START_TIME ASC;


SELECT 
QUERY_ID,
LISTAGG(CASE WHEN OPERATOR_TYPE='Insert' then OPERATOR_ATTRIBUTES['table_names'][0] else NULL end,' ,') as TRGT_TBL,
LISTAGG(CASE WHEN OPERATOR_TYPE='TableScan' then OPERATOR_ATTRIBUTES['table_name'] else NULL end,' ,') as SRC_TBL
from table(get_query_operator_stats('01ad784b-0404-a28d-004a-a2072102eb3e'))
where operator_type in ('Insert','TableScan')
GROUP BY 1

SELECT * FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY" WHERE QUERY_ID='01ad89b1-0404-a4ba-004a-a207225b3ce6';

SELECT * FROM table(get_query_operator_stats('01ad89b1-0404-a4ba-004a-a207225b3ce6')) ORDER BY STEP_ID, PARENT_OPERATOR_ID;
