


EXECUTE IMMEDIATE $$

declare query_id string;

query string;

c1 cursor for

select query_id

from "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"

WHERE WAREHOUSE_NAME LIKE 'P01%LOAD%' AND 

START_TIME >= '2023-09-01'  

AND QUERY_TYPE IN ('INSERT','MERGE','UPDATE')

AND USER_NAME IN ('SRCUWRATEDP')

AND query_id not in (select query_id from TEMP_DB.TEMP_SCHEMA.query_operator_join_stats);

begin

  open c1;

  for record in c1 do

    query := record.query_id;

INSERT INTO TEMP_DB.TEMP_SCHEMA.query_operator_join_stats

    WITH CTE_GQOS AS (

    SELECT * FROM TABLE(GET_QUERY_OPERATOR_STATS (:query))

),

CTE_TBL_INFO AS (

  SELECT 

    QUERY_ID,

    LISTAGG(CASE WHEN OPERATOR_TYPE='Insert' THEN OPERATOR_ATTRIBUTES['table_names'][0] ELSE NULL END,' ,') AS TRGT_TBL,

    LISTAGG(CASE WHEN OPERATOR_TYPE='TableScan' THEN OPERATOR_ATTRIBUTES  ELSE NULL END,' ,') AS SRC_TBL,

    LISTAGG(CASE WHEN OPERATOR_TYPE='TableScan' THEN OPERATOR_STATISTICS['pruning']  ELSE NULL END,' ,') AS SRC_PRUNING_STATS

    FROM CTE_GQOS

    WHERE OPERATOR_TYPE IN ('Insert','TableScan') and QUERY_ID IS NOT NULL

    GROUP BY QUERY_ID

),

CTE_CHILD_OPERATORS AS (

    SELECT STEP_ID, PARENT_OPERATOR_ID,

        CASE WHEN MAX(ROW_NUM) = 2 THEN MAX(BUILD_TYPE) END AS BUILD_TYPE,

        CASE WHEN MAX(ROW_NUM) = 2 THEN MAX(PROBE_TYPE) END AS PROBE_TYPE,

        CASE WHEN MAX(ROW_NUM) = 2 THEN MAX(BUILD_ROWS) END AS BUILD_ROWS,

        CASE WHEN MAX(ROW_NUM) = 2 THEN MAX(PROBE_ROWS) END AS PROBE_ROWS

    FROM (

        SELECT STEP_ID, OPERATOR_ID, ARRAY_TO_STRING(PARENT_OPERATORS,'') AS PARENT_OPERATOR_ID, OPERATOR_STATISTICS,

            ROW_NUMBER() OVER (PARTITION BY STEP_ID, PARENT_OPERATOR_ID ORDER BY OPERATOR_ID) AS ROW_NUM,

            CASE WHEN ROW_NUM = 1 THEN OPERATOR_TYPE END AS BUILD_TYPE,

            CASE WHEN ROW_NUM = 2 THEN OPERATOR_TYPE END AS PROBE_TYPE,

            CASE WHEN ROW_NUM = 1 THEN OPERATOR_STATISTICS:output_rows::INT END AS BUILD_ROWS,

            CASE WHEN ROW_NUM = 2 THEN OPERATOR_STATISTICS:output_rows::INT END AS PROBE_ROWS

        FROM CTE_GQOS

    ) P

    GROUP BY STEP_ID, PARENT_OPERATOR_ID

),

CTE_FINAL AS(

SELECT

    P.QUERY_ID,

    P.STEP_ID,

    P.OPERATOR_ID,

    P.OPERATOR_TYPE,

    P.OPERATOR_STATISTICS,

    P.EXECUTION_TIME_BREAKDOWN,

    P.OPERATOR_ATTRIBUTES,

    C.BUILD_TYPE,

    C.PROBE_TYPE,

    C.BUILD_ROWS,

    C.PROBE_ROWS,

    p.operator_statistics:output_rows::int as output_rows,

 

    CASE WHEN P.STEP_ID > 1000 THEN TRUE

    ELSE FALSE END AS OOM_ERROR,


    CASE WHEN P.OPERATOR_TYPE='Sort' AND P.OPERATOR_ID > 3 THEN TRUE ELSE FALSE END AS UNNECESSARY_SORT,


    CASE WHEN  ARRAY_CONTAINS('additional_join_condition'::VARIANT,OBJECT_KEYS(P.OPERATOR_ATTRIBUTES)) AND

    NOT ARRAY_CONTAINS('equality_join_condition'::VARIANT,OBJECT_KEYS(P.OPERATOR_ATTRIBUTES))

    THEN TRUE ELSE FALSE END AS RANGE_JOIN,


    CASE WHEN P.OPERATOR_TYPE IN ('Join','CartesianJoin') THEN

        C.BUILD_ROWS > C.PROBE_ROWS*10 AND

        C.BUILD_ROWS > 1000000 AND

        P.OPERATOR_STATISTICS:output_rows*10 < C.BUILD_ROWS AND

        NOT C.PROBE_TYPE = 'JoinFilter'

    ELSE FALSE

    END AS NON_OPTIMAL_JOIN,


    CASE WHEN P.OPERATOR_TYPE IN ('Join','CartesianJoin') THEN 

    (C.BUILD_ROWS*C.PROBE_ROWS) = OPERATOR_STATISTICS:output_rows::int

    ELSE FALSE

    END AS CARTESIAN_PRODUCT,

 

    CASE WHEN P.OPERATOR_TYPE IN ('Join','CartesianJoin') THEN

    GREATEST(C.BUILD_ROWS,C.PROBE_ROWS)*1.5::int < OPERATOR_STATISTICS:output_rows::int

    ELSE FALSE

    END AS JOIN_EXPLOSION

 

FROM CTE_GQOS P

LEFT JOIN CTE_CHILD_OPERATORS C 

  ON P.STEP_ID = C.STEP_ID 

  AND C.PARENT_OPERATOR_ID = P.OPERATOR_ID

WHERE NON_OPTIMAL_JOIN OR JOIN_EXPLOSION OR CARTESIAN_PRODUCT OR (OOM_ERROR AND OPERATOR_ID = 1) OR RANGE_JOIN OR UNNECESSARY_SORT

)

SELECT T.QUERY_ID, T.TRGT_TBL, T.SRC_TBL, T.SRC_PRUNING_STATS, 

F.STEP_ID ,F.OPERATOR_ID ,F.OPERATOR_TYPE ,F.OPERATOR_STATISTICS ,F.EXECUTION_TIME_BREAKDOWN ,F.OPERATOR_ATTRIBUTES ,F.BUILD_TYPE ,F.PROBE_TYPE 

,F.BUILD_ROWS ,F.PROBE_ROWS ,F.OUTPUT_ROWS ,F.OOM_ERROR ,F.UNNECESSARY_SORT ,F.RANGE_JOIN ,F.NON_OPTIMAL_JOIN ,F.CARTESIAN_PRODUCT ,F.JOIN_EXPLOSION

FROM CTE_TBL_INFO T

LEFT JOIN CTE_FINAL F

ON T.QUERY_ID = F.QUERY_ID

;    

  end for;

  end;

  $$;
